name: Deploy on development VPS

on:
  push:
    branches: ['production']

  workflow_dispatch:

env:
  APP_NAME: gs-backend

jobs:
  deploy:
    name: Deploy on development VPS
    runs-on: ubuntu-latest

    steps:
      - name: Check code base
        uses: actions/checkout@v2

      - name: Create '.env' file
        shell: bash
        env:
          ENV: ${{ secrets.ENV_FILE }}
        run: |
          echo "$ENV" > .env

      - name: Deploying using SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_SECRET_KEY }}
          port: 22
          script: |
            cd ~/apps/$APP_NAME
            git pull origin main
            git status
            npm install
            pm2 start /dist/src/main.js --name $APP_NAME

      # - name: Install dependencies and build
      #   run: |
      #     npm install
      #     npm run build

      # - name: Deploy to VPS
      #   run: |
      #     scp -r ./dist/* ${{secrets.SSH_USER}}@${{secrets.SSH_HOST}}:/apps/$APP_NAME
      #     ssh ${{secrets.SSH_USER}}@${{secrets.SSH_HOST}} 'cd /apps/$APP_NAME/src && node'
